<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#4f46e5">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>La Dolorosa</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #4f46e5; --primary-light: #e0e7ff; --primary-dark: #3730a3;
  --bg: #f8fafc; --card: #ffffff;
  --text: #0f172a; --muted: #64748b; --border: #e2e8f0;
  --success: #10b981; --success-bg: #d1fae5;
  --danger: #ef4444; --danger-bg: #fee2e2;
  --warning: #f59e0b; --warning-bg: #fef3c7;
  --radius: 16px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}

* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; 
  -webkit-touch-callout: none; 
  user-select: none; 
  -webkit-user-select: none;
}

input, textarea, .receipt-paper { 
  user-select: text !important; 
  -webkit-user-select: text !important; 
}

body { 
  margin: 0; 
  background: var(--bg); 
  color: var(--text); 
  font-family: 'Inter', sans-serif; 
  font-size: 14px; 
  overscroll-behavior-y: none; 
}

/* --- LANDING PAGE (SELECCI√ìN) --- */
#landing-page {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: var(--bg); z-index: 5000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 20px;
  transition: opacity 0.3s ease;
}
.landing-content { width: 100%; max-width: 400px; text-align: center; }
.landing-logo { font-size: 60px; margin-bottom: 10px; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
.landing-title { font-size: 28px; font-weight: 900; color: var(--text); margin: 0 0 30px 0; letter-spacing: -1px; }
.venue-btn {
  width: 100%; background: white; border: 1px solid var(--border); padding: 20px;
  margin-bottom: 15px; border-radius: 20px; font-size: 18px; font-weight: 800;
  color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer;
  transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between;
}
.venue-btn:active { transform: scale(0.98); background: var(--primary-light); }
.venue-btn span:last-child { font-size: 26px; }

/* --- APP PRINCIPAL --- */
#app-container { display: none; padding-bottom: 140px; }

/* HEADER */
header {
  background: var(--card); padding: 12px 20px; position: sticky; top: 0; z-index: 1000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
  padding-top: env(safe-area-inset-top); height: 70px;
}
.logo-container { display: flex; align-items: center; gap: 8px; cursor: pointer; transition: opacity 0.2s; }
.logo-container:active { opacity: 0.6; }
.back-arrow { color: var(--primary); margin-right: 4px; }
.logo-icon { font-size: 26px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
header h1 { margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

.header-actions { display: flex; align-items: center; gap: 12px; }

/* BOT√ìN DE MODO EDICI√ìN (L√ÅPIZ) */
.btn-edit-toggle { 
  background: none; border: none; cursor: pointer; padding: 8px;
  color: var(--muted); transition: all 0.2s ease;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
}
.btn-edit-toggle:active { background-color: var(--bg); transform: scale(0.95); }
.btn-edit-toggle.active { 
  color: var(--primary); 
  background-color: var(--primary-light); 
  box-shadow: 0 0 0 1px var(--primary-light);
}

.total-badge { text-align: right; }
.total-badge small { display: block; font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; }
.total-badge div { font-size: 1.4rem; font-weight: 800; color: var(--text); line-height: 1.1; }

.container { padding: 15px; margin: 0 auto; max-width: 800px; }

/* NAVEGACI√ìN */
.nav-scroll {
  display: flex; overflow-x: auto; gap: 10px; padding: 10px 20px;
  position: sticky; top: 70px; z-index: 900; background: var(--bg);
  margin: -15px -15px 15px -15px; -webkit-overflow-scrolling: touch;
  cursor: grab; border-bottom: 1px solid rgba(0,0,0,0.05); scrollbar-width: none; 
}
.nav-scroll::-webkit-scrollbar { display: none; }
.tab-btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  white-space: nowrap; padding: 10px 18px; border-radius: 20px; border: 1px solid transparent;
  background: var(--card); color: var(--muted); font-weight: 600; font-size: 13px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; flex-shrink: 0; 
}
.tab-btn.active { background: var(--text); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-1px); }
.tab-btn-add { background: var(--primary-light); color: var(--primary); border: 1px solid var(--primary-light); }
.tab-btn-editor { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; display: none; }
.tab-btn-editor.visible { display: inline-flex; }

/* CARDS & UTILS */
.card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 16px; border: 1px solid var(--border); }
.card-header { padding: 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.card-title { font-weight: 700; font-size: 15px; color: var(--text); }
.hidden { display: none !important; }

/* LIST ITEMS */
.item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px dashed var(--border); }
.item-row:last-child { border-bottom: none; }
.item-info b { display: block; font-size: 14px; }
.item-info small { color: var(--muted); }

/* EDITOR STYLES */
.editor-section-title { font-size: 12px; font-weight: 800; color: var(--muted); text-transform: uppercase; margin: 20px 0 10px 5px; letter-spacing: 0.5px; }
.editor-card-item { padding: 12px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; background: #fff; }
.editor-card-item:last-child { border-bottom: none; }
.editor-inputs-group { display: flex; flex-direction: column; gap: 6px; width: 100%; }
.editor-input-row { display: flex; gap: 8px; }
.editor-input { 
  padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; 
  font-family: 'Inter', sans-serif; font-size: 13px; width: 100%; background: #f8fafc;
  transition: all 0.2s;
}
.editor-input:focus { outline: none; border-color: var(--primary); background: #fff; }
.editor-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
.btn-delete-item { 
  color: var(--danger); background: var(--danger-bg); border: none; border-radius: 8px; 
  width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
}
.btn-delete-item:active { transform: scale(0.95); }

/* NEW ITEM FORM */
.new-item-container { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 40px; }
.new-item-title { font-weight: 800; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: var(--primary); }
.form-grid { display: grid; gap: 12px; }

/* --- SELECTORES BONITOS (UPDATED) --- */
.select-fancy {
  appearance: none; -webkit-appearance: none; 
  background-color: #fff; 
  border: 1px solid var(--border); 
  border-radius: 12px;
  padding: 12px 40px 12px 16px;
  font-size: 14px; 
  font-weight: 700; 
  color: var(--text); 
  cursor: pointer; 
  width: 100%;
  box-shadow: 0 2px 5px rgba(0,0,0,0.03);
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 16px;
  transition: all 0.2s ease;
}
.select-fancy:focus { 
  outline: none; 
  border-color: var(--primary); 
  background-color: #fff; 
  box-shadow: 0 0 0 3px var(--primary-light);
}
/* Estilo espec√≠fico para el selector peque√±o "entre" */
.select-compact {
  padding: 8px 30px 8px 12px;
  font-size: 13px;
  background-position: right 10px center;
  background-size: 14px;
}

/* GENERAL STYLES */
.pax-header-input {
  font-size: 18px; font-weight: 800; color: var(--primary);
  border: 1px solid transparent; background: transparent; width: 100%;
  outline: none; padding: 5px; border-radius: 6px; transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
}
.pax-header-input:focus { background: var(--bg); border-color: var(--primary-light); color: var(--text); }

/* STEPPER */
.stepper { display: flex; align-items: center; background: var(--bg); border-radius: 10px; padding: 2px; }
.stepper btn {
  width: 40px; height: 36px; border: none; background: white; border-radius: 8px;
  font-weight: 800; font-size: 18px; color: var(--primary); cursor: pointer;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
}
.stepper btn:active { transform: scale(0.95); background: #e0e7ff; }
.stepper span { min-width: 30px; text-align: center; font-weight: 700; font-size: 14px; }

/* ACCORDION */
details { border-bottom: 1px solid var(--border); transition: all 0.3s ease; }
details:last-of-type { border-bottom: none; }
summary { padding: 15px; font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; background: #fff; }
summary:hover { background: #f8fafc; }
summary::-webkit-details-marker { display: none; }
summary::after { content: '+'; font-size: 18px; font-weight: 400; color: var(--muted); }
details[open] summary::after { content: '-'; color: var(--primary); }
details[open] summary { background: #fafafa; border-bottom: 1px solid var(--border); color: var(--primary); }

/* RESUMEN DETALLADO */
.balance-container details { border: none; margin-bottom: 10px; background:transparent; }
.balance-container summary { background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 0; color: var(--text) !important; }
.balance-container details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: 1px solid var(--border); background: #fff; }
.balance-detail-list { background: #fff; border: 1px solid var(--border); border-top: none; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; padding: 10px 15px; font-size: 12px; color: var(--muted); }
.balance-detail-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f1f5f9; }
.balance-detail-item:last-child { border-bottom: none; }
.is-payer { background: var(--success-bg); border-color: #bbf7d0; }
.is-debtor { background: var(--danger-bg); border-color: #fecaca; }

/* TICKET STYLE */
.receipt-paper {
  background: #fff; width: 100%; max-width: 360px; margin: 10px auto; padding: 20px;
  font-family: 'Courier New', Courier, monospace; color: #222; position: relative;
  filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
}
.receipt-paper::after {
  content: ""; position: absolute; left: 0; bottom: -10px; width: 100%; height: 10px;
  background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
  background-position: top left, top right; background-size: 10px 10px; background-repeat: repeat-x;
}
.receipt-header { text-align: center; margin-bottom: 20px; }
.receipt-header h2 { font-size: 28px; margin: 0; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #000; }
.receipt-header p { font-size: 12px; margin: 2px 0; color: #555; }
.receipt-divider { border-top: 1px dashed #222; margin: 10px 0; }
.receipt-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; font-size: 13px; line-height: 1.4; }
.receipt-row span:first-child { text-align: left; padding-right: 10px; }
.receipt-row span:last-child { text-align: right; white-space: nowrap; font-weight: 700; }
.receipt-total { margin-top: 15px; border-top: 2px solid #222; border-bottom: 2px solid #222; padding: 10px 0; display: flex; justify-content: space-between; font-size: 18px; font-weight: 900; }
.receipt-footer { text-align: center; margin-top: 20px; font-size: 11px; color: #555; }
.barcode { height: 30px; background: repeating-linear-gradient(90deg, #222, #222 2px, transparent 2px, transparent 4px, #222 4px, #222 8px); margin: 15px auto; width: 80%; opacity: 0.8; }

/* BUTTONS */
.fab-container { position: fixed; bottom: 25px; right: 25px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
.fab-btn { padding: 12px 20px; border-radius: 50px; font-weight: 700; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.1s, background 0.2s; font-size: 14px; }
.fab-btn:active { transform: scale(0.95); }
.fab-share { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
.fab-copy { background: var(--text); color: white; box-shadow: 0 4px 15px rgba(15, 23, 42, 0.4); }

.btn-action { width: 100%; padding: 18px; margin-top: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; transition: all 0.2s ease; border: none; position: relative; overflow: hidden; }
.btn-action:active { transform: scale(0.98); }
.btn-reset { background: #f1f5f9; color: #475569; box-shadow: 0 2px 0 #cbd5e1; }
.btn-reset:active { box-shadow: none; transform: translateY(2px); }
.btn-factory { background: #fee2e2; color: #991b1b; box-shadow: 0 2px 0 #fecaca; margin-bottom: 60px; }
.btn-factory:active { box-shadow: none; transform: translateY(2px); }
.btn-delete-pax { background: var(--danger-bg); border: none; color: var(--danger); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
.btn-delete-pax:hover { background: #fecaca; }

.split-row { margin-top: 8px; background: #fff; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); display: flex; gap: 8px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }

.general-banner { background: var(--warning-bg); color: #92400e; padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 13px; border: 1px solid #fcd34d; display: flex; align-items: center; gap: 10px; }
</style>
</head>
<body>

<div id="landing-page">
  <div class="landing-content">
    <span class="landing-logo">üí∏</span>
    <h1 class="landing-title">¬øD√≥nde estamos?</h1>
    
    <button class="venue-btn" onclick="startApp('aiur')">
      <span>Club Ciclista Irun√©s</span>
      <span>üö¥</span>
    </button>
    
    <button class="venue-btn" onclick="startApp('ekhi')">
      <span>La Salle</span>
      <span>üéì</span>
    </button>
    
    <button class="venue-btn" onclick="startApp('galarza')">
      <span>Atsegi√±a</span>
      <span>üë®‚Äçüç≥</span>
    </button>
  </div>
</div>

<div id="app-container">
  <header>
    <div class="logo-container" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="back-arrow"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      <span class="logo-icon">üí∏</span>
      <h1 style="font-size:1.2rem; line-height:1;">La <span style="color:var(--text)">Dolorosa</span></h1>
    </div>
    
    <div class="header-actions">
        <button id="btnEditMode" class="btn-edit-toggle" onclick="toggleAdminMode()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
        </button>
        <div class="total-badge">
          <small>A PAGAR</small>
          <div id="headerTotal">0.00‚Ç¨</div>
        </div>
    </div>
  </header>

  <div class="container">
    <div class="nav-scroll" id="navContainer"></div>
    <div id="views"></div>
  </div>

  <div class="fab-container hidden" id="actionButtons">
    <button class="fab-btn fab-copy" id="btnCopy" onclick="copyBill()">
      <span>üìã Copiar</span>
    </button>
    <button class="fab-btn fab-share" onclick="shareNative()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
      <span>Compartir</span>
    </button>
  </div>
</div>

<script type="module">
// --- FIREBASE SETUP ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, off, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAcmywgX6l4x_dTnmA1c_CbtAh7LfSx4vg",
  authDomain: "la-dolorosa-68870.firebaseapp.com",
  databaseURL: "https://la-dolorosa-68870-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "la-dolorosa-68870",
  storageBucket: "la-dolorosa-68870.firebasestorage.app",
  messagingSenderId: "387013198617",
  appId: "1:387013198617:web:91910b92149292fe913b88"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_CODE = "1234";

// --- MEN√ö BASE POR DEFECTO ---
// Propiedad 'v': 'all' (ambos), 'pax' (solo participantes), 'common' (solo general)
const BASE_ITEMS = [
  { cat: "üç∑ Ardoak / Vinos", n: "Ardo beltza ¬∑ Tinto", p: 3.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Ardo gorria ¬∑ Rosado", p: 3.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Rueda Bitacora", p: 4.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Crianza Glorioso", p: 7.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Cuarto crianza", p: 5.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Txakoli", p: 7.50, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Moscato", p: 5.00, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Sagardoa ¬∑ Sidra", p: 3.00, v: 'all' },
  { cat: "üç∑ Ardoak / Vinos", n: "Cava", p: 10.00, v: 'all' },
  { cat: "üçæ Deskorxea / Descorche", n: "Descorche / Kanpoko", p: 2.50, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "San Miguel/Estrella", p: 1.30, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "Daura", p: 1.80, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "Voll-Damm", p: 1.50, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "0,0", p: 1.30, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "Radler", p: 1.20, v: 'all' },
  { cat: "üç∫ Garagardoak / Cervezas", n: "Alhambra", p: 2.00, v: 'all' },
  { cat: "ü•§ Freskagarriak / Refrescos", n: "Coca-Cola", p: 1.20, v: 'all' },
  { cat: "ü•§ Freskagarriak / Refrescos", n: "Kas Laranja/Limoia", p: 1.00, v: 'all' },
  { cat: "ü•§ Freskagarriak / Refrescos", n: "T√≥nica Schweppes", p: 1.50, v: 'all' },
  { cat: "ü•§ Freskagarriak / Refrescos", n: "Aquarius", p: 1.50, v: 'all' },
  { cat: "ü•§ Freskagarriak / Refrescos", n: "Ura ¬∑ Agua", p: 0.60, v: 'all' },
  { cat: "‚òï Kafeak / Caf√©s", n: "Kafea ¬∑ Caf√©", p: 1.20, v: 'all' },
  { cat: "‚òï Kafeak / Caf√©s", n: "Kafeinagabeko", p: 1.20, v: 'all' },
  { cat: "‚òï Kafeak / Caf√©s", n: "Cola Cao", p: 1.00, v: 'all' },
  { cat: "‚òï Kafeak / Caf√©s", n: "Esne ¬∑ Leche", p: 1.00, v: 'all' },
  { cat: "‚òï Kafeak / Caf√©s", n: "Infusioak", p: 1.00, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Patxarana", p: 2.50, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Uxual Krema", p: 2.20, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Ginebra Beefeater", p: 2.20, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Ron Habana/Barcel√≥", p: 2.20, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Vodka Smirnoff/Absolut", p: 2.50, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Cointreau", p: 2.70, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Torres 10", p: 2.20, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Armagnac", p: 3.70, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Whisky J.B.", p: 2.60, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "Belar/Hierbas", p: 2.20, v: 'all' },
  { cat: "üç∏ Likoreak / Licores", n: "J√§germeister", p: 2.50, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Olioa ¬∑ Aceite", p: 2.00, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Ongailuak ¬∑ Adrezos", p: 0.50, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Tupper", p: 0.25, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Gasa ¬∑ Gas (15min)", p: 1.80, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Bazkaria ¬∑ Comida", p: 3.00, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Afaria ¬∑ Cena", p: 3.00, v: 'all' },
  { cat: "üç≥ Sukaldea / Cocina", n: "Merienda", p: 2.50, v: 'all' }
];
const LASALLE_ITEMS = [
  // üç∑ VINOS

 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Reserva Remelluri", p: 26.90, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Reserva Cerro A√±on", p: 12.00, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Pierola", p: 12.40, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Vi√±a Real", p: 8.50, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Mar Vitoria", p: 7.85, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Glorioso", p: 7.70, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Campillo", p: 10.90, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Crianza Protos", p: 19.80, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Tinto Don Hugo", p: 3.40, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Sidra Zapiain ¬∑ Sagardoa", p: 3.25, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Rosado Ilagares", p: 4.50, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Lambrusco Monteberin", p: 4.25, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Blanco Vi√±a Mayor Verdejo", p: 6.65, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Txakoli Gaintza", p: 8.10, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Albari√±o Segrel", p: 9.90, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Cava OR", p: 13.00, v: 'all' },
 { cat: "üç∑ Ardoak / Vinos", n: "Cava Ondarre Millennium", p: 8.60, v: 'all' },

  // üçæ DESCORCHE
 { cat: "üçæ Deskorxea / Descorche", n: "Vino x 750 ml", p: 2.50, v: 'all' },
 { cat: "üçæ Deskorxea / Descorche", n: "Licores x litro", p: 3.00, v: 'all' },
 { cat: "üçæ Deskorxea / Descorche", n: "Cava x 750 ml", p: 2.50, v: 'all' },
 { cat: "üçæ Deskorxea / Descorche", n: "Refrescos 2L", p: 1.60, v: 'all' },
 { cat: "üçæ Deskorxea / Descorche", n: "Aceite x litro", p: 1.60, v: 'all' },
 { cat: "üçæ Deskorxea / Descorche", n: "No asistencia por comensal", p: 2.00, v: 'all' },

  // üç∫ CERVEZAS
 { cat: "üç∫ Garagardoak / Cervezas", n: "San Miguel", p: 1.00, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "San Miguel 0.0", p: 1.00, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "Heineken Grande", p: 1.50, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "Amstel Oro", p: 1.70, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "Leffe", p: 2.95, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "Voll-Damm", p: 2.70, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "San Miguel Sin Gluten", p: 1.45, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "18/70", p: 2.00, v: 'all' },
 { cat: "üç∫ Garagardoak / Cervezas", n: "Amstel Radler", p: 1.90, v: 'all' },


  // ü•§ REFRESCOS
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Coca-Cola", p: 1.10, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Coca-Cola Zero", p: 1.10, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Kas Naranja", p: 1.10, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Kas Lim√≥n", p: 1.10, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "T√≥nica Schweppes", p: 1.30, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Gaseosa La Casera 50cl", p: 1.00, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Agua Uralai 1.5L", p: 1.00, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Agua Botell√≠n 0.33", p: 0.50, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Agua con gas Vichy Catal√°n", p: 1.80, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Zumos Lambda", p: 1.35, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Batidos", p: 1.25, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Vermouth Martini Rojo", p: 1.50, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Bitter Cinzano", p: 2.00, v: 'all' },
 { cat: "ü•§ Freskagarriak / Refrescos", n: "Bitter Kas", p: 1.40, v: 'all' },

 // ‚òï Kafeak / Caf√©s
 { cat: "‚òï Kafeak / Caf√©s", n: "Caf√© o infusiones", p: 1.00, v: 'all' },
 { cat: "‚òï Kafeak / Caf√©s", n: "Nesquik / ColaCao", p: 1.00, v: 'all' },

 // üç∏ Likoreak / Licores
 { cat: "üç∏ Likoreak / Licores", n: "Brandy Torres 10", p: 2.00, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ginebra Gordons", p: 2.20, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ginebra Beefeater", p: 2.50, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ginebra Bombay", p: 2.70, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Patxaran Navarra", p: 2.10, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "An√≠s Cadenas", p: 1.70, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Crema Ruavieja", p: 1.85, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Hierbas Ruavieja", p: 1.85, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Orujo Ruavieja", p: 1.70, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ron Bacardi", p: 2.00, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ron Barcel√≥", p: 2.30, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Ron Havana Club", p: 2.10, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Whisky J.B.", p: 2.15, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Whisky Ballantines", p: 2.00, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Whisky Chivas", p: 3.80, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Armagnac", p: 3.80, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Cointreau", p: 2.85, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Vodka Smirnoff", p: 2.20, v: 'all' },
 { cat: "üç∏ Likoreak / Licores", n: "Patxaran Etxeko", p: 2.10, v: 'all' },

 // üç≥ Sukaldea / Cocina
 { cat: "üç≥ Sukaldea / Cocina", n: "Vajilla + limpieza (mantel tela)", p: 3.20, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Vajilla + limpieza (mantel papel)", p: 2.75, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Servilleta tela", p: 0.50, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Fuego 30 min", p: 2.00, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Horno 30 min", p: 2.00, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Plancha 30 min", p: 2.00, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Aceite √öbeda 250ml", p: 2.50, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Aceite √öbeda 500ml", p: 4.50, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Aceite girasol 1L", p: 2.80, v: 'all' },
 { cat: "üç≥ Sukaldea / Cocina", n: "Envases/Tupper 1.5‚Äì2L", p: 0.80, v: 'all' },
 
// ü•´ Kontserbak / Conservas
 { cat: "ü•´ Kontserbak / Conservas", n: "Pimiento piquillo", p: 2.40, v: 'all' },
 { cat: "ü•´ Kontserbak / Conservas", n: "Aceitunas", p: 1.75, v: 'all' },
 { cat: "ü•´ Kontserbak / Conservas", n: "Esp√°rragos", p: 6.85, v: 'all' },
 { cat: "ü•´ Kontserbak / Conservas", n: "At√∫n claro Pescamar", p: 1.90, v: 'all' },
];

// Variables din√°micas
let ITEMS = [];
let CATEGORIES = {};
let DB_PATH = '';
let MENU_PATH = '';
let CURRENT_VENUE = '';
let isAdmin = false;
let isInitialLoad = true; // Control de primera carga

let state = {
  names: ["Persona 1", "Persona 2"], 
  selections: [], 
  common: [], 
  payerIdx: 0,
  activeTab: 0 
};

let UI_STATE = { general: new Set(), paxes: {} };

// --- FUNCI√ìN DE ARRANQUE ---
window.startApp = function(venue) {
  // Configurar seg√∫n local elegido
  CURRENT_VENUE = venue;
  DB_PATH = `gastosPro_v4_${venue}`;
  MENU_PATH = `menu_v4_${venue}`;
  isInitialLoad = true; // Resetear flag al entrar

  document.getElementById('app-container').style.display = 'block';
  setTimeout(() => document.getElementById('landing-page').style.opacity = '0', 50);
  setTimeout(() => document.getElementById('landing-page').style.display = 'none', 300);

  init();
}

// --- VOLVER AL MEN√ö (SIN BORRAR DATOS) ---
window.goBack = function() {
  if(DB_PATH) off(ref(db, DB_PATH));
  if(MENU_PATH) off(ref(db, MENU_PATH));

  isAdmin = false;
  document.getElementById('btnEditMode').classList.remove('active');
  document.getElementById('tab-btn-editor').classList.remove('visible');

  document.getElementById('landing-page').style.display = 'flex';
  setTimeout(() => document.getElementById('landing-page').style.opacity = '1', 50);
  document.getElementById('app-container').style.display = 'none';
}

window.toggleAdminMode = function() {
    if(isAdmin) {
        isAdmin = false;
        document.getElementById('btnEditMode').classList.remove('active');
        document.getElementById('tab-btn-editor').classList.remove('visible');
        if(state.activeTab === 99) switchTab(0);
    } else {
        const code = prompt("üîë C√≥digo de Administrador:");
        if(code === ADMIN_CODE) {
            isAdmin = true;
            document.getElementById('btnEditMode').classList.add('active');
            document.getElementById('tab-btn-editor').classList.add('visible');
            alert("Modo Edici√≥n Activado");
        } else if(code !== null) {
            alert("C√≥digo incorrecto");
        }
    }
}

// --- LOGICA DEL SISTEMA ---
function captureUiState() {
  const genView = document.getElementById('view-general');
  if(genView) {
    UI_STATE.general = new Set();
    genView.querySelectorAll('details[open] summary').forEach(el => UI_STATE.general.add(el.innerText.trim()));
  }
  state.names.forEach((_, i) => {
    const pView = document.getElementById(`view-pax-${i}`);
    if(pView) {
      UI_STATE.paxes[i] = new Set();
      pView.querySelectorAll('details[open] summary').forEach(el => UI_STATE.paxes[i].add(el.innerText.trim()));
    }
  });
}

function saveData() {
  if(!DB_PATH) return;
  set(ref(db, DB_PATH), state).catch(err => console.error(err));
}

function saveMenu() {
    if(!MENU_PATH) return;
    set(ref(db, MENU_PATH), ITEMS).catch(err => console.error(err));
}

function buildCategories() {
    CATEGORIES = {};
    ITEMS.forEach((it, i) => { 
        if(!CATEGORIES[it.cat]) CATEGORIES[it.cat] = []; 
        CATEGORIES[it.cat].push({...it, idx: i}); 
    });
}

function init() {
  document.body.style.minHeight = window.innerHeight + "px";
  enableDragScroll(); 

  // 1. CARGAR MEN√ö DEL LOCAL
  onValue(ref(db, MENU_PATH), (snapshot) => {
      const menuData = snapshot.val();
     if (menuData) {
  ITEMS = menuData;
} else {
  if (CURRENT_VENUE === "ekhi") {
    ITEMS = JSON.parse(JSON.stringify(LASALLE_ITEMS));
  } if (CURRENT_VENUE === "Galarza") {
    ITEMS = JSON.parse(JSON.stringify(BASE_ITEMS));
  } if (CURRENT_VENUE === "aiur") {
    ITEMS = JSON.parse(JSON.stringify(BASE_ITEMS));
  }
  saveMenu();
}

      
      buildCategories();

      // Si ya hay datos cargados, refrescar vistas para que aparezca el contenido en General
      if(state.selections) {
          renderNav();
          renderAllViews();
      }
  });

  // 2. CARGAR GASTOS
  onValue(ref(db, DB_PATH), (snapshot) => {
    if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT')) {
        const data = snapshot.val();
        if(data) state = data;
        updateCalculations(); 
        return; 
    }

    captureUiState();
    const data = snapshot.val();
    if(data) {
      state = data;
      if(!state.selections) state.selections = [];
      if(!state.common) state.common = new Array(ITEMS.length).fill(0);
      
      if(state.common.length < ITEMS.length) {
         const diff = ITEMS.length - state.common.length;
         for(let k=0; k<diff; k++) state.common.push(0);
         state.selections.forEach(sel => {
            for(let k=0; k<diff; k++) sel.push({ solo: 0, shared: [] });
         });
      }
      
      if(Object.keys(CATEGORIES).length === 0) buildCategories();

      // --- LOGICA DE FORZADO DE PESTA√ëA AL ENTRAR ---
      if(isInitialLoad) {
          state.activeTab = 0; // Forzar Balances al entrar
          isInitialLoad = false;
      }
      // ---------------------------------------------

      renderNav();
      renderAllViews();
      updateCalculations();

    } else {
      resetSelections();
      saveData();
      switchTab(0);
    }
  });
}

// FUNCIONES EDITOR
window.updateItemProp = function(idx, key, val) {
    if(key === 'p') val = parseFloat(val);
    ITEMS[idx][key] = val;
    saveMenu();
}

window.deleteItem = function(idx) {
    if(!confirm("¬øBorrar " + ITEMS[idx].n + "?")) return;
    ITEMS.splice(idx, 1);
    state.common.splice(idx, 1);
    state.selections.forEach(sel => sel.splice(idx, 1));
    saveMenu();
    saveData();
}

window.addNewItem = function() {
    const name = document.getElementById('new-name').value;
    const price = parseFloat(document.getElementById('new-price').value);
    const cat = document.getElementById('new-cat').value;
    const vis = document.getElementById('new-vis').value;
    
    if(name && price && cat) {
        ITEMS.push({ n: name, p: price, cat: cat, v: vis });
        state.common.push(0);
        state.selections.forEach(sel => sel.push({ solo: 0, shared: [] }));
        
        saveMenu();
        saveData();
        
        document.getElementById('new-name').value = '';
        document.getElementById('new-price').value = '';
        alert("Art√≠culo a√±adido con √©xito");
    } else {
        alert("Rellena todos los campos");
    }
}

// ... FUNCIONES CORE ...
function resetSelections() {
  state.selections = state.names.map(() => ITEMS.map(() => ({ solo: 0, shared: [] })));
  state.common = new Array(ITEMS.length).fill(0);
  state.activeTab = 0;
}

function softReset() {
  if(!confirm("üîÑ ¬øPoner contadores a cero?")) return;
  resetSelections();
  state.payerIdx = 0;
  saveData();
  switchTab(0);
}

function factoryReset() {
  if(!confirm("üß® ¬øBORRAR TODO de " + CURRENT_VENUE.toUpperCase() + "?\n(Esto dejar√° solo a 1 participante)")) return;
  remove(ref(db, DB_PATH));
  
  // Reseteo total dejando solo 1 participante
  state.names = ["Persona 1"];
  state.payerIdx = 0;
  resetSelections(); // Se ajusta a la nueva longitud de 1 persona
  
  saveData();
  renderNav();
  renderAllViews();
  switchTab(0);
}

function updateVal(paxIdx, itemIdx, delta) {
  const current = state.selections[paxIdx][itemIdx].solo || 0;
  state.selections[paxIdx][itemIdx].solo = Math.max(0, current + delta);
  saveData();
}

function updateCommon(itemIdx, delta) {
  const current = state.common[itemIdx] || 0;
  state.common[itemIdx] = Math.max(0, current + delta);
  saveData();
}

function addShared(paxIdx, itemIdx) {
  if (!state.selections[paxIdx][itemIdx].shared) state.selections[paxIdx][itemIdx].shared = [];
  state.selections[paxIdx][itemIdx].shared.push({ q: 1, d: state.names.length });
  saveData();
}

function updateShared(paxIdx, itemIdx, shareIdx, key, val) {
  const item = state.selections[paxIdx][itemIdx].shared[shareIdx];
  if(key === 'q') item.q = Math.max(0, item.q + val);
  if(key === 'd') item.d = parseInt(val);
  if(item.q === 0 && key === 'q') state.selections[paxIdx][itemIdx].shared.splice(shareIdx, 1);
  saveData();
}

function updateName(idx, newName) {
  state.names[idx] = newName;
  saveData(); 
}

function syncNameTab(idx, newName) {
  const btn = document.getElementById(`tab-btn-${idx + 3}`);
  if(btn) btn.innerText = newName || `Persona ${idx + 1}`;
}

function setPayer(idx) {
  state.payerIdx = parseInt(idx);
  saveData();
  renderSummaryView(); // Actualizaci√≥n inmediata de la vista
}

function addParticipant() {
  state.names.push(`Persona ${state.names.length + 1}`);
  state.selections.push(ITEMS.map(() => ({ solo: 0, shared: [] })));
  saveData();
  switchTab(state.names.length + 2);
}

function removeParticipant(idx) {
  if(state.names.length <= 1) return alert("M√≠nimo 1 persona.");
  if(!confirm("¬øBorrar a " + state.names[idx] + "?")) return;
  state.names.splice(idx, 1);
  state.selections.splice(idx, 1);
  if(state.payerIdx >= state.names.length) state.payerIdx = 0;
  saveData();
  switchTab(0);
}

function renderNav() {
  const nav = document.getElementById('navContainer');
  nav.innerHTML = '';
   
  const btnSum = document.createElement('button');
  btnSum.className = `tab-btn ${state.activeTab === 0 ? 'active' : ''}`;
  btnSum.innerText = 'üìä Balances';
  btnSum.onclick = () => switchTab(0);
  nav.appendChild(btnSum);

  const btnTicket = document.createElement('button');
  btnTicket.className = `tab-btn ${state.activeTab === 1 ? 'active' : ''}`;
  btnTicket.innerText = 'üßæ Ticket';
  btnTicket.onclick = () => switchTab(1);
  nav.appendChild(btnTicket);

  const btnGen = document.createElement('button');
  btnGen.className = `tab-btn ${state.activeTab === 2 ? 'active' : ''}`;
  btnGen.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
    General
  `;
  btnGen.onclick = () => switchTab(2);
  nav.appendChild(btnGen);
  
  const btnEdit = document.createElement('button');
  btnEdit.id = 'tab-btn-editor';
  btnEdit.className = `tab-btn tab-btn-editor ${isAdmin ? 'visible' : ''} ${state.activeTab === 99 ? 'active' : ''}`;
  btnEdit.innerText = '‚úèÔ∏è Editor';
  btnEdit.onclick = () => switchTab(99);
  nav.appendChild(btnEdit);

  state.names.forEach((name, i) => {
    const btn = document.createElement('button');
    btn.className = `tab-btn ${state.activeTab === i + 3 ? 'active' : ''}`; 
    btn.id = `tab-btn-${i+3}`;
    btn.innerText = name;
    btn.onclick = () => switchTab(i + 3);
    nav.appendChild(btn);
  });

  const btnAdd = document.createElement('button');
  btnAdd.className = 'tab-btn tab-btn-add';
  btnAdd.innerText = '+ Persona';
  btnAdd.onclick = addParticipant;
  nav.appendChild(btnAdd);
}

function switchTab(tabIdx) {
  state.activeTab = tabIdx;
  const navBtns = document.getElementById('navContainer').children;
  [...navBtns].forEach((btn, i) => {
     if(btn.id === 'tab-btn-editor') {
         btn.classList.toggle('active', tabIdx === 99);
     } else {
         btn.classList.remove('active');
     }
  });
  
  const targetBtn = (tabIdx === 0) ? navBtns[0] : 
                    (tabIdx === 1) ? navBtns[1] : 
                    (tabIdx === 2) ? navBtns[2] :
                    document.getElementById(`tab-btn-${tabIdx}`);
  if(targetBtn) targetBtn.classList.add('active');

  const views = document.getElementById('views').children;
  [...views].forEach(v => v.classList.add('hidden'));

  if(tabIdx === 0) document.getElementById('view-summary').classList.remove('hidden');
  else if(tabIdx === 1) document.getElementById('view-global').classList.remove('hidden');
  else if(tabIdx === 2) document.getElementById('view-general').classList.remove('hidden');
  else if(tabIdx === 99) document.getElementById('view-editor').classList.remove('hidden');
  else {
      const pDiv = document.getElementById(`view-pax-${tabIdx-3}`);
      if(pDiv) pDiv.classList.remove('hidden');
  }

  if(tabIdx === 0) renderSummaryView();
  if(tabIdx === 1) renderGlobalView();
  if(tabIdx === 2) renderGeneralView();
  if(tabIdx === 99) renderEditorView();
  
  document.getElementById('actionButtons').classList.toggle('hidden', tabIdx !== 0);
}

function renderAllViews() {
  const container = document.getElementById('views');
  container.innerHTML = '';
   
  const sumDiv = document.createElement('div'); sumDiv.id = 'view-summary'; container.appendChild(sumDiv);
  const globalDiv = document.createElement('div'); globalDiv.id = 'view-global'; globalDiv.classList.add('hidden'); container.appendChild(globalDiv);
  const genDiv = document.createElement('div'); genDiv.id = 'view-general'; genDiv.classList.add('hidden'); container.appendChild(genDiv);
  const editDiv = document.createElement('div'); editDiv.id = 'view-editor'; editDiv.classList.add('hidden'); container.appendChild(editDiv);

  state.names.forEach((_, i) => {
    const pDiv = document.createElement('div');
    pDiv.id = `view-pax-${i}`;
    pDiv.classList.add('hidden');
    container.appendChild(pDiv);
    renderParticipantView(i);
  });
  
  switchTab(state.activeTab);
}

function renderEditorView() {
    const container = document.getElementById('view-editor');
    const uniqueCats = [...new Set(ITEMS.map(i => i.cat))];
    const catOptions = uniqueCats.map(c => `<option value="${c}">${c}</option>`).join('');

    let html = `
      <div class="new-item-container">
          <div class="new-item-title">‚ú® A√±adir Nuevo Producto</div>
          <div class="form-grid">
              <input type="text" id="new-name" class="editor-input" placeholder="Nombre (ej: Croquetas)">
              <div style="display:flex; gap:10px;">
                  <input type="number" id="new-price" class="editor-input" placeholder="Precio (‚Ç¨)" step="0.01">
                  <select id="new-vis" class="select-fancy">
                      <option value="all">Ver en: Ambos</option>
                      <option value="pax">Ver en: Participantes</option>
                      <option value="common">Ver en: General</option>
                  </select>
              </div>
              <select id="new-cat" class="select-fancy" style="background-color:#f8fafc">
                  ${catOptions}
                  <option value="üÜï Otros">üÜï Otros</option>
              </select>
              <button class="btn-action" style="background:var(--primary); color:white; margin-top:5px; padding:12px" onclick="addNewItem()">+ A√ëADIR AHORA</button>
          </div>
      </div>
    `;

    // Renderizar categor√≠as
    for(const [cat, items] of Object.entries(CATEGORIES)) {
        html += `<div class="editor-section-title">${cat}</div>`;
        html += `<div class="card" style="margin-bottom:20px;">`;
        items.forEach(item => {
            const visLabel = (item.v === 'pax') ? 'üë§ Pax' : (item.v === 'common') ? 'üåç Gen' : 'üë• Todo';
            const visColor = (item.v === 'pax') ? '#dbeafe' : (item.v === 'common') ? '#fef3c7' : '#f1f5f9';
            
            html += `
                <div class="editor-card-item">
                    <div class="editor-inputs-group">
                        <input type="text" class="editor-input" value="${item.n}" onchange="updateItemProp(${item.idx}, 'n', this.value)" style="font-weight:600">
                        <div class="editor-input-row">
                             <input type="number" class="editor-input" value="${item.p}" step="0.01" onchange="updateItemProp(${item.idx}, 'p', this.value)" style="width:70px">
                             <select class="editor-input" onchange="updateItemProp(${item.idx}, 'v', this.value)" style="background:${visColor}; border:none;">
                                <option value="all" ${!item.v || item.v==='all'?'selected':''}>Todo</option>
                                <option value="pax" ${item.v==='pax'?'selected':''}>Solo Pax</option>
                                <option value="common" ${item.v==='common'?'selected':''}>Solo Gen</option>
                             </select>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button class="btn-delete-item" onclick="deleteItem(${item.idx})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    // Espacio final
    html += `<div style="height:50px"></div>`;
    
    container.innerHTML = html;
}

function renderSummaryView() {
  const container = document.getElementById('view-summary');
  const calc = calculateMath();
  const payerOpts = state.names.map((n, i) => `<option value="${i}" ${i === state.payerIdx ? 'selected' : ''}>${n}</option>`).join('');
  let html = `
    <div class="card" style="padding:15px; border-left: 5px solid var(--primary)">
      <span style="font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase;">¬øQui√©n pag√≥ la cuenta?</span>
      <select onchange="setPayer(this.value)" class="select-fancy" style="width:100%; margin-top:8px; padding:10px; font-size:16px;">${payerOpts}</select>
    </div>
  `;

  html += `<div class="card"><div class="card-header"><span class="card-title">Balance por Persona</span></div><div class="balance-container" style="padding:15px">`;
   
  calc.balances.forEach((b, i) => {
    const isPayer = (i === state.payerIdx);
    const colorClass = isPayer ? 'is-payer' : 'is-debtor';
    const label = isPayer ? 'RECIBE' : 'DEBE';
    const symbol = isPayer ? '+' : '-';
    const amount = isPayer ? (calc.grandTotal - b.consumed) : b.consumed;
     
    let detailsList = b.items.length > 0 
      ? b.items.map(it => `<div class="balance-detail-item"><span>${it.desc}</span><span>${it.cost.toFixed(2)}‚Ç¨</span></div>`).join('')
      : '<div style="padding:10px; text-align:center">Nada consumido</div>';

    if(amount > 0.05 || b.consumed > 0) {
      html += `
        <details>
          <summary class="${colorClass}">
             <div style="text-align:left">
                <b style="font-size:15px">${state.names[i]}</b><br>
                <small style="opacity:0.8">Consumido: ${b.consumed.toFixed(2)}‚Ç¨</small>
             </div>
             <div style="text-align:right">
                <small style="font-weight:800; font-size:10px;">${label}</small><br>
                <span style="font-size:18px; font-weight:800;">${symbol}${amount.toFixed(2)}‚Ç¨</span>
             </div>
          </summary>
          <div class="balance-detail-list">
            ${detailsList}
            <div style="margin-top:8px; border-top:1px solid #e2e8f0; padding-top:4px; text-align:right; font-weight:700">
               Total Consumido: ${b.consumed.toFixed(2)}‚Ç¨
            </div>
          </div>
        </details>
      `;
    }
  });
  html += `</div></div>`;
   
  html += `
    <button class="btn-action btn-reset" onclick="softReset()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 16l5 5v-5"></path></svg>
      Resetear Contadores
    </button>
    <button class="btn-action btn-factory" onclick="factoryReset()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      Eliminar Todas las Cuentas
    </button>
    <div style="height:30px"></div>
  `;
  container.innerHTML = html;
}

function renderGlobalView() {
  const container = document.getElementById('view-global');
  const calc = calculateMath();
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

  let venueNameDisplay = "LA DOLOROSA";
  if (CURRENT_VENUE === 'aiur') venueNameDisplay = "CLUB CICLISTA IRUN√âS";
  if (CURRENT_VENUE === 'ekhi') venueNameDisplay = "LA SALLE";
  if (CURRENT_VENUE === 'galarza') venueNameDisplay = "ATSEGI√ëA";

  if(calc.globalItems.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted)">A√±ade productos para generar el ticket</div>`;
    return;
  }

  let itemsHtml = '';
  calc.globalItems.forEach(item => {
    const unitPrice = item.p.toFixed(2);
    const qty = (item.q % 1 === 0) ? item.q : item.q.toFixed(2);
    itemsHtml += `
      <div class="receipt-row">
        <span>${item.n}<br><small>${qty} x ${unitPrice}‚Ç¨</small></span>
        <span>${item.t.toFixed(2)}‚Ç¨</span>
      </div>`;
  });

  container.innerHTML = `
    <div class="receipt-paper">
      <div class="receipt-header">
        <h2>${venueNameDisplay}</h2>
        <p>"Sarna con gusto no pica"</p>
        <p>Fecha: ${dateStr} - Hora: ${timeStr}</p>
        <p>Ticket No: ${Math.floor(Math.random() * 9000) + 1000}</p>
      </div>
      <div class="receipt-divider"></div>
      <div style="margin: 15px 0;">${itemsHtml}</div>
      <div class="receipt-divider"></div>
      <div class="receipt-total">
        <span>TOTAL</span>
        <span>${calc.grandTotal.toFixed(2)}‚Ç¨</span>
      </div>
      <div class="receipt-footer">
        <div class="barcode"></div>
        <p>GRACIAS POR SU VISITA</p>
        <p>IVA INCLUIDO</p>
      </div>
    </div>
  `;
}

function renderGeneralView() {
  const container = document.getElementById('view-general');
  const openSet = UI_STATE.general || new Set();

  let html = `
    <div class="general-banner">
      <div style="font-size:20px;">üåç</div>
      <div>
        <b>Gastos Comunes</b><br>
        Lo que a√±adas aqu√≠ se divide autom√°ticamente entre <b>todos</b> (${state.names.length} personas).
      </div>
    </div>
  `;

  // Iterar categor√≠as, filtrando items que NO deben verse en general
  for(const [cat, items] of Object.entries(CATEGORIES)) {
    // Filtrar items: mostrar si no tiene 'v' (legacy), si es 'all' o si es 'common'
    const validItems = items.filter(it => !it.v || it.v === 'all' || it.v === 'common');
    
    if(validItems.length === 0) continue;

    const isOpen = openSet.has(cat) ? 'open' : '';
    html += `<div class="card"><details ${isOpen}><summary>${cat}</summary><div>`;
    
    validItems.forEach(it => {
      const qty = state.common[it.idx] || 0;
      html += `
        <div class="item-row">
          <div class="item-info">
            <b>${it.n}</b>
            <small>${it.p.toFixed(2)}‚Ç¨</small>
          </div>
          <div class="stepper">
            <btn onclick="updateCommon(${it.idx}, -1)">-</btn>
            <span style="color:${qty>0 ? 'var(--warning)':'inherit'}">${qty}</span>
            <btn onclick="updateCommon(${it.idx}, 1)">+</btn>
          </div>
        </div>
      `;
    });
    html += `</div></details></div>`;
  }
  container.innerHTML = html;
}

function renderParticipantView(pIdx) {
  const container = document.getElementById(`view-pax-${pIdx}`);
  if(!container) return;
  const openSet = UI_STATE.paxes[pIdx] || new Set();

  let html = `
    <div class="card">
      <div class="card-header">
         <input type="text"
           class="pax-header-input"
           value="${state.names[pIdx]}"
           oninput="syncNameTab(${pIdx}, this.value)"
           onblur="updateName(${pIdx}, this.value)"
           onkeydown="if(event.key==='Enter') this.blur()"
           placeholder="Nombre..."
         >
         <button onclick="removeParticipant(${pIdx})" class="btn-delete-pax">
           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
         </button>
      </div>
    </div>
  `;

  for(const [cat, items] of Object.entries(CATEGORIES)) {
    if(cat === "üç≥ Sukaldea / Cocina") continue;
    
    // Filtrar items: mostrar si no tiene 'v', si es 'all' o si es 'pax'
    const validItems = items.filter(it => !it.v || it.v === 'all' || it.v === 'pax');
    if(validItems.length === 0) continue;

    const isOpen = openSet.has(cat) ? 'open' : '';
    html += `<div class="card"><details ${isOpen}><summary>${cat}</summary><div>`;
    validItems.forEach(it => {
      const sel = state.selections[pIdx][it.idx];
      const soloQty = sel.solo || 0;
      let sharedHtml = '';
      if(sel.shared && sel.shared.length > 0) {
        sel.shared.forEach((sh, shIdx) => {
          sharedHtml += `
            <div class="split-row">
              <span style="font-size:10px; font-weight:800; color:var(--primary)">GRP</span>
              <div class="stepper" style="transform:scale(0.8)">
                <btn onclick="updateShared(${pIdx}, ${it.idx}, ${shIdx}, 'q', -1)">-</btn>
                <span>${sh.q}</span>
                <btn onclick="updateShared(${pIdx}, ${it.idx}, ${shIdx}, 'q', 1)">+</btn>
              </div>
              <span style="font-size:11px; color:#666">entre</span>
              <select class="select-fancy select-compact" onchange="updateShared(${pIdx}, ${it.idx}, ${shIdx}, 'd', this.value)">
                ${Array.from({length: state.names.length}, (_, k) => 
                  `<option value="${k+1}" ${sh.d == k+1 ? 'selected':''}>${k+1}</option>`).join('')}
              </select>
            </div>
          `;
        });
      }
      html += `
        <div class="item-row">
          <div class="item-info">
            <b>${it.n}</b>
            <small>${it.p.toFixed(2)}‚Ç¨</small>
            ${sharedHtml}
          </div>
          <div style="display:flex; flex-direction:column; align-items:end; gap:5px;">
             <div class="stepper">
                <btn onclick="updateVal(${pIdx}, ${it.idx}, -1)">-</btn>
                <span style="color:${soloQty>0 ? 'var(--primary)':'inherit'}">${soloQty}</span>
                <btn onclick="updateVal(${pIdx}, ${it.idx}, 1)">+</btn>
             </div>
             <button onclick="addShared(${pIdx}, ${it.idx})" style="border:none; background:none; color:var(--primary); font-size:11px; font-weight:700; cursor:pointer;">+ Compartir</button>
          </div>
        </div>
      `;
    });
    html += `</div></details></div>`;
  }
  container.innerHTML = html;
}

function calculateMath() {
  let grandTotal = 0;
  const numPax = state.names.length;
  const paxData = state.names.map(() => ({ consumed: 0, items: [] }));
  const globalItemsMap = {}; 

  const addToGlobal = (idx, qty, total, name, price) => {
      if(!globalItemsMap[idx]) globalItemsMap[idx] = { n: name, q: 0, t: 0, p: price };
      globalItemsMap[idx].q += qty;
      globalItemsMap[idx].t += total;
  };

  if(state.common) {
    state.common.forEach((qty, iIdx) => {
      if(qty > 0) {
        const itemDef = ITEMS[iIdx];
        const totalCommonCost = qty * itemDef.p;
        const costPerPax = totalCommonCost / numPax;
        paxData.forEach(pd => {
          pd.consumed += costPerPax;
          pd.items.push({ desc: `Parte Prop. ${itemDef.n} (${qty} total)`, cost: costPerPax });
        });
        grandTotal += totalCommonCost;
        addToGlobal(iIdx, qty, totalCommonCost, itemDef.n, itemDef.p);
      }
    });
  }

  state.selections.forEach((paxSel, pIdx) => {
    paxSel.forEach((itemSel, iIdx) => {
      const itemDef = ITEMS[iIdx];
      const price = itemDef.p;
      if(itemSel.solo > 0) {
        const cost = itemSel.solo * price;
        paxData[pIdx].consumed += cost;
        paxData[pIdx].items.push({ desc: `${itemSel.solo}x ${itemDef.n}`, cost: cost });
        grandTotal += cost;
        addToGlobal(iIdx, itemSel.solo, cost, itemDef.n, price);
      }
      if(itemSel.shared) {
        itemSel.shared.forEach(sh => {
          if(sh.q > 0 && sh.d > 0) {
            const myShareCost = (sh.q / sh.d) * price;
            paxData[pIdx].consumed += myShareCost;
            paxData[pIdx].items.push({ desc: `${sh.q}/${sh.d} de ${itemDef.n}`, cost: myShareCost });
            grandTotal += myShareCost;
            addToGlobal(iIdx, (sh.q / sh.d), myShareCost, itemDef.n, price);
          }
        });
      }
    });
  });

  const globalItemsArr = Object.values(globalItemsMap).map(i => ({
    n: i.n, q: i.q, t: i.t, p: i.p 
  })).filter(i => i.t > 0);

  return { grandTotal, balances: paxData, globalItems: globalItemsArr };
}

function updateCalculations() {
  const calc = calculateMath();
  document.getElementById('headerTotal').innerText = calc.grandTotal.toFixed(2) + "‚Ç¨";
}

function getBillText() {
  const calc = calculateMath();
  const payer = state.names[state.payerIdx];
  const now = new Date();
  
  let venueNameDisplay = "LA DOLOROSA";
  if (CURRENT_VENUE === 'aiur') venueNameDisplay = "CLUB CICLISTA IRUN√âS";
  if (CURRENT_VENUE === 'ekhi') venueNameDisplay = "LA SALLE";
  if (CURRENT_VENUE === 'galarza') venueNameDisplay = "ATSEGI√ëA";
  
  let t = `üßæ *LA DOLOROSA - ${venueNameDisplay}* \n`;
  t += `üìÖ ${now.toLocaleDateString()}  üïí ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}\n`;
  t += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`; 
  t += `üí∞ *TOTAL CUENTA:* ${calc.grandTotal.toFixed(2)}‚Ç¨\n`;
  t += `üëë *PAG√ì:* ${payer}\n`;
  t += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
  
  t += `üí∏ *PAGAR A ${payer.toUpperCase()}:*\n`;
  
  let anyDebt = false;
  calc.balances.forEach((b, i) => {
    if(i === state.payerIdx) return;
    const amount = b.consumed;
    if(amount > 0.05) {
      anyDebt = true;
      t += `‚ñ´Ô∏è *${state.names[i]}* üëâ ${amount.toFixed(2)}‚Ç¨\n`;
    }
  });

  if(!anyDebt) t += "¬°Nadie debe nada! üéâ\n";
  
  t += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
  
  return t;
}

window.shareNative = async function() {
  const text = getBillText();
  const shareData = { title: 'La Dolorosa', text: text };
  if (navigator.share) {
    try { await navigator.share(shareData); } catch (err) { console.log('Error', err); }
  } else {
    alert("Navegador no soporta compartir nativo.");
  }
}

window.copyBill = function() {
  const text = getBillText();
  const btn = document.getElementById('btnCopy');
  const originalHtml = btn.innerHTML;
  
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(showSuccess);
  } else {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("Copy");
    textArea.remove();
    showSuccess();
  }
  
  function showSuccess() {
    btn.style.background = "#10b981";
    btn.innerHTML = "<span>‚úÖ Copiado</span>";
    setTimeout(() => {
      btn.style.background = "";
      btn.innerHTML = originalHtml;
    }, 2000);
  }
}

function enableDragScroll() {
  const slider = document.getElementById('navContainer');
  let isDown = false;
  let startX;
  let scrollLeft;
  slider.addEventListener('mousedown', (e) => {
    isDown = true;
    slider.style.cursor = 'grabbing';
    startX = e.pageX - slider.offsetLeft;
    scrollLeft = slider.scrollLeft;
  });
  slider.addEventListener('mouseleave', () => { isDown = false; slider.style.cursor = 'grab'; });
  slider.addEventListener('mouseup', () => { isDown = false; slider.style.cursor = 'grab'; });
  slider.addEventListener('mousemove', (e) => {
    if(!isDown) return;
    e.preventDefault();
    const x = e.pageX - slider.offsetLeft;
    const walk = (x - startX) * 2; 
    slider.scrollLeft = scrollLeft - walk;
  });
}

// EXPONER FUNCIONES
window.updateVal = updateVal;
window.updateCommon = updateCommon;
window.addShared = addShared;
window.updateShared = updateShared;
window.updateName = updateName;
window.syncNameTab = syncNameTab; 
window.setPayer = setPayer;
window.switchTab = switchTab;
window.addParticipant = addParticipant;
window.removeParticipant = removeParticipant;
window.softReset = softReset;
window.factoryReset = factoryReset;
</script>
</body>
</html>
